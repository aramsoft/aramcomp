<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.dam.app.dao.KnoAppraisalMapper">

	<select id="selectKnoAppraisalList" resultType="egovMap">
        /* 구현 Sql */
		<![CDATA[
			SELECT A.KNWLDG_ID				AS "knoId"     		
				 , A.KNWLDG_NM				AS "knoNm"
				 , B.KNWLDG_TY_NM			AS "knoTypeNm"	 
			     , D.USER_NM				AS "userNm"
				 , A.KNWLDG_EVL				AS "knoAps"
			     , A.EVL_DE					AS "appYmd"
			  FROM COMTN_DAM_KNOIFM A
				   LEFT OUTER JOIN COMTN_DAM_MAP_KNO B
						ON A.KNWLDG_TY_CODE = B.KNWLDG_TY_CODE
				   LEFT OUTER JOIN COMTN_DAM_MAP_TEAM C
						ON B.ORGNZT_ID = C.ORGNZT_ID
				   LEFT OUTER JOIN COMTN_DAM_PRO E
						ON A.KNWLDG_TY_CODE = E.KNWLDG_TY_CODE
				   LEFT OUTER JOIN COMVN_USER_MASTER D  	
				       	ON A.FRST_REGISTER_ID = D.ESNTL_ID
			 WHERE A.OTHBC_AT = 'Y'
			   AND COALESCE(A.KNWLDG_EVL,'0') NOT IN ('3')
		]]>
     	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "KNWLDG_NM"'>
                 <![CDATA[ AND A.KNWLDG_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>	
            </when>
            <when test='searchVO.searchCondition == "USER_NM"'>
                 <![CDATA[ AND D.USER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>	
            </when>
        </choose>
		</if>
       /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
	</select>

	<select id="selectKnoAppraisalListCnt" resultType="int">
		<![CDATA[
		   SELECT COUNT(*) as totcnt 
			  FROM COMTN_DAM_KNOIFM A
				   LEFT OUTER JOIN COMTN_DAM_MAP_KNO B
						ON  A.KNWLDG_TY_CODE = B.KNWLDG_TY_CODE
				   LEFT OUTER JOIN COMTN_DAM_MAP_TEAM C
						ON  B.ORGNZT_ID = C.ORGNZT_ID
				   LEFT OUTER JOIN COMTN_DAM_PRO E
						ON  A.KNWLDG_TY_CODE = E.KNWLDG_TY_CODE
				   LEFT OUTER JOIN COMVN_USER_MASTER D  	
				       	ON A.FRST_REGISTER_ID = D.ESNTL_ID
			 WHERE A.OTHBC_AT = 'Y'
			   AND COALESCE(A.KNWLDG_EVL,'0') NOT IN ('3')
		]]>
     	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "KNWLDG_NM"'>
                 <![CDATA[ AND A.KNWLDG_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>	
            </when>
            <when test='searchVO.searchCondition == "USER_NM"'>
                 <![CDATA[ AND D.USER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>	
            </when>
        </choose>
		</if>
	</select>

	<select id="selectKnoAppraisal" resultType="knoAppraisalVO">
		<![CDATA[
			SELECT C.ORGNZT_NM				"orgnztNm"
			     , C.ORGNZT_ID				"orgnztId"
			     , B.KNWLDG_TY_NM			"knoTypeNm"			     			
			     , B.KNWLDG_TY_CODE			"knoTypeCd"
				 , A.KNWLDG_ID				"knoId"			     
				 , A.KNWLDG_NM				"knoNm"			     
			     , A.KNWLDG_CN				"knoCn"
                 , A.OTHBC_AT				"othbcAt"              
                 , A.ATCH_FILE_ID			"atchFileId"
                 , A.EVL_DE					"appYmd"
			     , A.KNWLDG_EVL				"knoAps"
			     , A.FRST_REGISTER_ID		"frstRegisterId"
			     , A.FRST_REGIST_PNTTM		"frstRegisterPnttm"
			     , A.LAST_UPDUSR_ID			"lastUpdusrId"
			     , A.LAST_UPDT_PNTTM		"lastUpdusrPnttm"			     
			  FROM COMTN_DAM_KNOIFM A
				   LEFT OUTER JOIN COMTN_DAM_MAP_KNO B
						ON A.KNWLDG_TY_CODE = B.KNWLDG_TY_CODE
				   LEFT OUTER JOIN COMTN_DAM_MAP_TEAM C
						ON B.ORGNZT_ID = C.ORGNZT_ID
			 WHERE A.OTHBC_AT = 'Y'					
               AND A.KNWLDG_ID = #{knoId}
		]]>
	</select>

	<update id="updateKnoAppraisal">
		<![CDATA[
            UPDATE COMTN_DAM_KNOIFM 
               SET EVL_DE			= #{appYmd}
		         , KNWLDG_EVL       = #{knoAps}            
                 , EXPERT_ID    	= #{speId}                
                 , LAST_UPDT_PNTTM 	= now()
             WHERE OTHBC_AT 		= 'Y'	
               AND KNWLDG_ID        = #{knoId} 
		]]> 
	</update>

</mapper>
       