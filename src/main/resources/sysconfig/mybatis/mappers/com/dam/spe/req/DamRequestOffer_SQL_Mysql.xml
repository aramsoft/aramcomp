<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.dam.spe.req.dao.RequestOfferMapper">

	<!-- 지식정보제공/지식정보요청::전문가수  -->
	<select id="selectRequestOfferSpeCnt"  resultType="int">
		<![CDATA[
			SELECT COUNT(EXPERT_ID) CNT 
			  FROM COMTN_DAM_PRO 
			 WHERE EXPERT_ID = #{speId}
		]]>
	</select>
	
	<!-- 지식정보제공/지식정보요청::하위 답변 수  -->
	<select id="selectRequestOfferDelCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(KNWLDG_ID) CNT
			  FROM COMTN_DAM_CALRES
			 WHERE 1=1
			   AND PARNTS_KNWLDG_ID = #{parentsKnoId}
		]]>
	</select>

	<!-- 지식정보제공/지식정보요청::목록조회 게시물정보 -->
	<select id="selectRequestOfferList"  resultType="egovMap">
        /* 구현 Sql */
		<![CDATA[
			SELECT A.KNWLDG_ID				AS "knoId" 
				 , (SELECT ORGNZT_NM 
				      FROM COMTN_DAM_MAP_TEAM 
				     WHERE ORGNZT_ID=A.ORGNZT_ID
				   ) 						AS "orgnztNm" 
	        	 , (SELECT KNWLDG_TY_NM 
	        	      FROM COMTN_DAM_MAP_KNO 
	        	     WHERE ORGNZT_ID=A.ORGNZT_ID 
	        	       AND KNWLDG_TY_CODE=A.KNWLDG_TY_CODE
	        	   ) 						AS "knoTypeNm" 
				 , A.KNWLDG_NM				AS "knoNm"
				 , A.THREAD_DEPTH			AS "threadDepth" 
				 , A.FRST_REGIST_PNTTM	 	AS "frstRegisterPnttm" 
				 , (SELECT USER_NM 
				      FROM COMVN_USER_MASTER 
				     WHERE ESNTL_ID = A.FRST_REGISTER_ID
				   )       					AS "frstRegisterNm" 
			  FROM COMTN_DAM_CALRES A
			 WHERE 1=1
		]]>
     	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "KNWLDG_NM"'>
                 <![CDATA[ AND A.KNWLDG_NM LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "KNWLDG_CN"'>
                 <![CDATA[ AND A.KNWLDG_CN LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
		<![CDATA[
			ORDER BY A.THREAD_GROUP_NO DESC, A.THREAD_NO ASC
		]]>
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{recordPerPage} OFFSET #{firstIndex}
        ]]>			
	</select>
	
	<!-- 지식정보제공/지식정보요청::목록조회_게시물 총갯수  -->
	<select id="selectRequestOfferListCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*) totcnt
			  FROM COMTN_DAM_CALRES A
			 WHERE 1=1
        ]]>			
     	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "KNWLDG_NM"'>
                 <![CDATA[ AND A.KNWLDG_NM LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "KNWLDG_CN"'>
                 <![CDATA[ AND A.KNWLDG_CN LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	</select>

	<!-- 지식정보제공/지식정보요청::상세보기 -->
	<select id="selectRequestOffer" resultType="requestOfferVO">
		<![CDATA[
			SELECT A.KNWLDG_ID				AS "knoId"	
			     , A.ORGNZT_ID				AS "orgnztId"
				 , (SELECT ORGNZT_NM 
				      FROM COMTN_DAM_MAP_TEAM 
				     WHERE ORGNZT_ID=A.ORGNZT_ID
				   ) 						AS "orgnztNm" 
			     , A.EXPERT_ID				AS "speId"
			     , A.KNWLDG_TY_CODE			AS "knoTypeCd"
	        	 , (SELECT KNWLDG_TY_NM 
	        	      FROM COMTN_DAM_MAP_KNO 
	        	     WHERE ORGNZT_ID=A.ORGNZT_ID 
	        	       AND KNWLDG_TY_CODE=A.KNWLDG_TY_CODE
	        	   ) 						AS "knoTypeNm" 
			     , A.EMPLYR_ID				AS "emplyrId"
			     , A.KNWLDG_NM				AS "knoNm"
			     , A.KNWLDG_CN				AS "knoCn"
			     , A.ATCH_FILE_ID			AS "atchFileId"
			     , A.PARNTS_KNWLDG_ID		AS "parentsKnoId"
			     , A.THREAD_DEPTH			AS "threadDepth"
			     , A.THREAD_NO				AS "threadNo"
			     , A.THREAD_GROUP_NO		AS "threadGroupNo"
			     , A.FRST_REGIST_PNTTM		AS "frstRegisterPnttm"
			     , A.FRST_REGISTER_ID		AS "frstRegisterId"
			     , A.LAST_UPDT_PNTTM		AS "lastUpdusrPnttm"
			     , A.LAST_UPDUSR_ID			AS "lastUpdusrId"
			  FROM COMTN_DAM_CALRES A
			 WHERE 1=1
			   AND A.KNWLDG_ID=#{knoId}
       	]]>			
	</select>

	<!-- #knoId# 지식정보제공/지식정보요청::입력  -->
	<insert id="insertRequestOffer">
		<selectKey resultType="int" keyProperty="threadGroupNo" order="BEFORE">
	 		SELECT IFNULL(MAX(THREAD_GROUP_NO)+1, 1) 
	 		  FROM COMTN_DAM_CALRES
		</selectKey>
		<![CDATA[
			INSERT INTO COMTN_DAM_CALRES (
					KNWLDG_ID
				  ,	ORGNZT_ID
				  ,	EXPERT_ID
				  ,	KNWLDG_TY_CODE
				  ,	EMPLYR_ID
				  ,	KNWLDG_NM
				  ,	KNWLDG_CN
				  ,	ATCH_FILE_ID
				  ,	PARNTS_KNWLDG_ID
				  ,	THREAD_DEPTH
				  ,	THREAD_NO
				  ,	THREAD_GROUP_NO
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			)VALUES(
					#{knoId}
					#{knoId}
				  ,	#{orgnztId, jdbcType=VARCHAR}
				  , #{speId, jdbcType=VARCHAR}
				  ,	#{knoTypeCd, jdbcType=VARCHAR}
				  ,	#{emplyrId, jdbcType=VARCHAR}
				  ,	#{knoNm, jdbcType=VARCHAR}
				  ,	#{knoCn, jdbcType=VARCHAR}
				  ,	#{atchFileId, jdbcType=VARCHAR}
				  ,	#{parentsKnoId, jdbcType=VARCHAR}
				  ,	0
				  ,	1
				  ,	#{threadGroupNo, jdbcType=NUMERIC}
				  , #{frstRegisterId}
				  , sysdate()
				  , #{frstRegisterId} 
				  , sysdate()
			)
       	]]>			
	</insert>

	<!-- 지식정보제공/지식정보요청::답변등록  -->
	<insert id="replyRequestOffer">
		<![CDATA[
			INSERT INTO COMTN_DAM_CALRES (
					KNWLDG_ID
				  ,	ORGNZT_ID
				  ,	EXPERT_ID
				  ,	KNWLDG_TY_CODE
				  ,	EMPLYR_ID
				  ,	KNWLDG_NM
				  ,	KNWLDG_CN
				  ,	ATCH_FILE_ID
				  ,	PARNTS_KNWLDG_ID
				  ,	THREAD_DEPTH
				  ,	THREAD_NO
				  ,	THREAD_GROUP_NO
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			)VALUES(
					#{knoId}
				  ,	#{orgnztId, jdbcType=VARCHAR}
				  ,	#{speId, jdbcType=VARCHAR}
				  ,	#{knoTypeCd, jdbcType=VARCHAR}
				  ,	#{emplyrId, jdbcType=VARCHAR}
				  ,	#{knoNm, jdbcType=VARCHAR}
				  ,	#{knoCn, jdbcType=VARCHAR}
				  ,	#{atchFileId, jdbcType=VARCHAR}
				  ,	#{parentsKnoId, jdbcType=VARCHAR}
				  ,	#{threadDepth, jdbcType=NUMERIC}
				  ,	#{threadNo, jdbcType=NUMERIC}
				  ,	#{threadGroupNo, jdbcType=NUMERIC}
				  , #{frstRegisterId}
				  , sysdate()
				  , #{frstRegisterId} 
				  , sysdate()
			)
      	]]>			
	</insert>

	<select id="getParentThreadNo" resultType="int">
		<![CDATA[
			SELECT THREAD_NO 
			  FROM COMTN_DAM_CALRES
			 WHERE 1=1
			   AND KNWLDG_ID = #{parentsKnoId}			
		]]>
	</select>
	
 	<update id="updateThreadNo" >
 		<![CDATA[
			UPDATE COMTN_DAM_CALRES 
			   SET THREAD_NO = #{threadNo}
			 WHERE 1=1
			   AND KNWLDG_ID = #{knoId}
 		]]>
 	</update>
 	
 	<update id="updateOtherThreadNo" >
 		<![CDATA[
			UPDATE COMTN_DAM_CALRES 
			   SET THREAD_NO = THREAD_NO + 1
			 WHERE 1=1
			   AND THREAD_GROUP_NO = #{threadGroupNo}
			   AND THREAD_NO > #{threadNo}
 		]]>
 	</update>
 	
	<!-- 지식정보제공/지식정보요청::수정  -->
	<update id="updateRequestOffer">
	 	<![CDATA[
			UPDATE COMTN_DAM_CALRES
			   SET ORGNZT_ID		= #{orgnztId, jdbcType=VARCHAR}
			     , EXPERT_ID		= #{speId, jdbcType=VARCHAR}
			     , KNWLDG_TY_CODE	= #{knoTypeCd, jdbcType=VARCHAR}
			     , EMPLYR_ID		= #{emplyrId, jdbcType=VARCHAR}
			     , KNWLDG_NM		= #{knoNm, jdbcType=VARCHAR}
			     , KNWLDG_CN		= #{knoCn, jdbcType=VARCHAR}
			     , ATCH_FILE_ID		= #{atchFileId, jdbcType=VARCHAR}
			     , LAST_UPDUSR_ID 	= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM  = sysdate()
			 WHERE KNWLDG_ID=#{knoId}
	 	]]>
	</update>

    <!-- 지식정보제공/지식정보요청::삭제  -->
	<delete id="deleteRequestOffer">
		<![CDATA[
			DELETE 
			  FROM COMTN_DAM_CALRES
			 WHERE KNWLDG_ID=#{knoId}
		]]>
	</delete>
	
</mapper>