<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.sts.dst.dao.DtaUseStatsMapper">

       <select id="selectDtaUseStatsList" resultType="dtaUseStatsVO">
        /* 구현 Sql */
        <![CDATA[
            SELECT A.BBS_ID
            	 , B.BBS_NM
            	 , A.NTT_ID
            	 , C.NTT_SJ
            	 , A.ATCH_FILE_ID
            	 , A.FILE_SN
            	 , D.ORIGNL_FILE_NM			AS "fileNm"
            	 , COUNT(*) 				AS "downCnt"
              FROM COMTN_DTA_USE_STATS A
                 , COMTN_BBS_MASTER B
                 , COMTN_BBS C
                 , COMTN_FILE_DETAIL D
             WHERE 1 = 1
               AND A.BBS_ID       = B.BBS_ID
               AND B.BBS_ID       = C.BBS_ID
               AND A.NTT_ID       = C.NTT_ID
               AND A.ATCH_FILE_ID = D.ATCH_FILE_ID
               AND A.FILE_SN      = D.FILE_SN
        ]]>
        	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
	        <choose>
	            <when test='searchVO.searchCondition == "BBS_NM"'>
	             <![CDATA[ AND B.BBS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
	            </when>
	        </choose>
			</if>
         	<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
        <![CDATA[
             GROUP BY A.BBS_ID
                    , B.BBS_NM
                    , A.NTT_ID
                    , C.NTT_SJ
                    , A.ATCH_FILE_ID
                    , A.FILE_SN
                    , D.ORIGNL_FILE_NM
        ]]>
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
    </select>

    <select id="selectDtaUseStatsListCnt" resultType="int">
            SELECT COUNT(*) AS totcnt
              FROM (SELECT A.BBS_ID
                         , B.BBS_NM
                         , A.NTT_ID
                         , A.ATCH_FILE_ID
                         , A.FILE_SN
                         , D.ORIGNL_FILE_NM
                         , COUNT(*) 		AS COUNT
                      FROM COMTN_DTA_USE_STATS A
                         , COMTN_BBS_MASTER B
                         , COMTN_BBS C
                         , COMTN_FILE_DETAIL D
                     WHERE 1 = 1
                       AND A.BBS_ID       = B.BBS_ID
                       AND B.BBS_ID       = C.BBS_ID
                       AND A.NTT_ID       = C.NTT_ID
                       AND A.ATCH_FILE_ID = D.ATCH_FILE_ID
                       AND A.FILE_SN      = D.FILE_SN
          	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
	        <choose>
	            <when test='searchVO.searchCondition == "BBS_NM"'>
	             <![CDATA[ AND B.BBS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
	            </when>
	        </choose>
			</if>
         	<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
                      GROUP BY A.BBS_ID
                            , B.BBS_NM
                            , A.NTT_ID
                            , A.ATCH_FILE_ID
                            , A.FILE_SN
                            , D.ORIGNL_FILE_NM) A
    </select>

    <select id="selectDtaUseStatsBarList" resultType="dtaUseStatsVO">
        <![CDATA[
            SELECT
        ]]>
	        <choose>
		        <when test='pmDateTy != null and pmDateTy != ""'>
		 	        <choose>
				        <when test='pmDateTy == "%Y"'>
	               			TO_CHAR(A.FRST_REGIST_PNTTM,'YYYY') 		AS "grpRegDate"
			            </when>
				        <when test='pmDateTy == "%Y-%m"'>
	               			TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMM') 	AS "grpRegDate"
		            	</when>
				        <when test='pmDateTy == "%Y-%m-%d"'>
	               			TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') 	AS "grpRegDate"
		        		</when>
		    		</choose>
	       		</when>	
	        	<otherwise>
       		   		TO_CHAR(A.FRST_REGIST_PNTTM,'YYYY') 		AS "grpRegDate"
 	        	</otherwise>
	        </choose>
             
        <![CDATA[
                 , COUNT(*) 				AS "grpCnt" 
              FROM COMTN_DTA_USE_STATS A
                 , COMTN_BBS_MASTER B
                 , COMTN_BBS C
                 , COMTN_FILE_DETAIL D
             WHERE 1 = 1
               AND A.BBS_ID       = B.BBS_ID
               AND B.BBS_ID       = C.BBS_ID
               AND A.NTT_ID       = C.NTT_ID
               AND A.ATCH_FILE_ID = D.ATCH_FILE_ID
               AND A.FILE_SN      = D.FILE_SN
        ]]>
        	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
	        <choose>
	            <when test='searchVO.searchCondition == "BBS_NM"'>
	             <![CDATA[ AND B.BBS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
	            </when>
	        </choose>
			</if>
          	<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
            
 	        <choose>
		        <when test='pmDateTy != null and pmDateTy != ""'>
		 	        <choose>
				        <when test='pmDateTy == "%Y"'>
			               GROUP BY TO_CHAR(A.FRST_REGIST_PNTTM,'YYYY')
			            </when>
				        <when test='pmDateTy == "%Y-%m"'>
			               GROUP BY TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMM')
		            	</when>
				        <when test='pmDateTy == "%Y-%m-%d"'>
			               GROUP BY TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD')
		        		</when>
		    		</choose>
	       		</when>	
	        	<otherwise>
	        		   GROUP BY TO_CHAR(A.FRST_REGIST_PNTTM,'YYYY')
	        	</otherwise>
	        </choose>
            
        <![CDATA[
             ORDER BY "grpRegDate" DESC
        ]]>
    </select>

    <select id="selectDtaUseStatsListBarListCnt" resultType="int">
            SELECT COUNT(*) 				AS totcnt
              FROM COMTN_DTA_USE_STATS A
                 , COMTN_BBS_MASTER B
                 , COMTN_BBS C
                 , COMTN_FILE_DETAIL D
             WHERE 1 = 1
               AND A.BBS_ID       = B.BBS_ID
               AND B.BBS_ID       = C.BBS_ID
               AND A.NTT_ID       = C.NTT_ID
               AND A.ATCH_FILE_ID = D.ATCH_FILE_ID
               AND A.FILE_SN      = D.FILE_SN
        	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
	        <choose>
	            <when test='searchVO.searchCondition == "BBS_NM"'>
	             <![CDATA[ AND B.BBS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
	            </when>
	        </choose>
			</if>
         	<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
     </select>

     <select id="selectDtaUseStats" resultType="dtaUseStatsVO">
            SELECT A.DTA_USE_STATS_ID
                 , A.BBS_ID
                 , B.BBS_NM
                 , A.NTT_ID
                 , C.NTT_SJ
                 , A.ATCH_FILE_ID
                 , A.FILE_SN
                 , D.ORIGNL_FILE_NM			AS "fileNm"
                 , A.FRST_REGISTER_ID		AS "userId"
                 , E.USER_NM				
                 , A.FRST_REGIST_PNTTM		AS "regdate" 
              FROM COMTN_DTA_USE_STATS A
                 , COMTN_BBS_MASTER B
                 , COMTN_BBS C
                 , COMTN_FILE_DETAIL D
                 , COMVN_USER_MASTER E
             WHERE 1 = 1
               AND A.BBS_ID           = B.BBS_ID
               AND A.BBS_ID           = C.BBS_ID
               AND A.NTT_ID           = C.NTT_ID
               AND A.ATCH_FILE_ID     = D.ATCH_FILE_ID
               AND A.FILE_SN          = D.FILE_SN
               AND A.FRST_REGISTER_ID = E.USER_ID
               AND A.BBS_ID           = #{bbsId}
               AND A.NTT_ID           = #{nttId}
               AND A.ATCH_FILE_ID     = #{atchFileId}
               AND A.FILE_SN          = #{fileSn}
       		<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
             ORDER BY A.DTA_USE_STATS_ID DESC
    </select>

    <select id="selectDtaUseStatsCnt" resultType="int">
            SELECT COUNT(*) 				AS totcnt
              FROM COMTN_DTA_USE_STATS A
                 , COMTN_BBS_MASTER B
                 , COMTN_BBS C
                 , COMTN_FILE_DETAIL D
                 , COMVN_USER_MASTER E
             WHERE 1 = 1
               AND A.BBS_ID           = B.BBS_ID
               AND A.BBS_ID           = C.BBS_ID
               AND A.NTT_ID           = C.NTT_ID
               AND A.ATCH_FILE_ID     = D.ATCH_FILE_ID
               AND A.FILE_SN          = D.FILE_SN
               AND A.FRST_REGISTER_ID = E.USER_ID
               AND A.BBS_ID           = #{bbsId}
               AND A.NTT_ID           = #{nttId}
               AND A.ATCH_FILE_ID     = #{atchFileId}
               AND A.FILE_SN          = #{fileSn}
        	<if test='pmFromDate != null and pmFromDate != ""'>
         		<if test='pmToDate != null and pmToDate != ""'>
                     AND TO_CHAR(A.FRST_REGIST_PNTTM,'YYYYMMDD') BETWEEN #{pmFromDate} AND #{pmToDate}
              	</if>
  			</if>
              ORDER BY A.DTA_USE_STATS_ID DESC
    </select>

    <select id="selectInsertDtaUseStats" resultType="dtaUseStatsVO">
        <![CDATA[
            SELECT C.BBS_ID
                 , C.NTT_ID
                 , A.ATCH_FILE_ID
                 , A.FILE_SN
              FROM COMTN_FILE_DETAIL A
                 , COMTN_FILE B
                 , COMTN_BBS C
             WHERE A.ATCH_FILE_ID = B.ATCH_FILE_ID
               AND A.ATCH_FILE_ID = C.ATCH_FILE_ID
               AND A.ATCH_FILE_ID = #{atchFileId}
               AND A.FILE_SN      = #{fileSn}
        ]]>
    </select>

    <insert id="insertDtaUseStats" >
        <![CDATA[
            INSERT INTO COMTN_DTA_USE_STATS ( 
        			DTA_USE_STATS_ID
        		  , BBS_ID
        		  , NTT_ID
        		  , ATCH_FILE_ID
        		  , FILE_SN
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
            ) VALUES (
        			#{dtaUseStatsId}
        		  , #{bbsId}
        		  , #{nttId}
        		  , #{atchFileId}
        		  , #{fileSn}
        		  , #{userId}
        		  , now()
        		  , #{userId}
        		  , now() 
            )
        ]]>
    </insert>

 </mapper>