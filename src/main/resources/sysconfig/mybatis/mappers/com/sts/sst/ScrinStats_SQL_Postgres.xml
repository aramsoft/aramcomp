<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.sts.sst.dao.ScrinStatsMapper">
	
	<!-- 화면통계 조회 -->
	<select id="selectScrinStats" resultType="statsVO">
		SELECT COALESCE(SUM(a.RDCNT),0) 			AS statsCo
	    	<choose>
	     		<when test='pdKind == "Y"'>
			 <!-- 기간검색(년) -->
		     , SUBSTR(OCCRRNC_DE, 1, 4) 	AS statsDate
	        	</when>
	        	<when test='pdKind == "M"'>
		     <!-- 기간검색(월) -->
		     , SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2) AS statsDate
	        	</when>
	        	<when test='pdKind == "D"'>
		     <!-- 기간검색(일) -->
		     , SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2) || '-' || SUBSTR(OCCRRNC_DE, 7, 2) AS statsDate
	        	</when>
	    	</choose>
		  FROM COMTS_WEB_LOG_SUMMARY a
		     , (SELECT PROGRM_STRE_PATH AS URL
			  	  FROM COMTN_PROGRM_LIST 
			 	 WHERE PROGRM_FILE_NM = #{detailStatsKind}) b
		 WHERE 1 = 1
		   <!-- 시작일자~종료일자 기간제한 -->
		   AND a.OCCRRNC_DE BETWEEN #{fromDate} AND #{toDate} 
		   AND a.URL LIKE CONCAT(b.URL,'%')
	    	<choose>
	     		<when test='pdKind == "Y"'>
		 GROUP BY SUBSTR(OCCRRNC_DE, 1, 4)
		 ORDER BY SUBSTR(OCCRRNC_DE, 1, 4)
	        	</when>
	        	<when test='pdKind == "M"'>
		 GROUP BY SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2)
		 ORDER BY SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2)
	        	</when>
	        	<when test='pdKind == "D"'>
		 GROUP BY SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2) || '-' || SUBSTR(OCCRRNC_DE, 7, 2)
		 ORDER BY SUBSTR(OCCRRNC_DE, 1, 4) || '-' || SUBSTR(OCCRRNC_DE, 5, 2) || '-' || SUBSTR(OCCRRNC_DE, 7, 2)
	        	</when>
	    	</choose>
	</select>
	
</mapper>