<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.sym.log.slg.dao.SysHistoryMapper">

	<select id="selectSysHistoryList"  resultType="egovMap">
		<![CDATA[
            SELECT *
              FROM (
            SELECT ROWNUM RNUM, ALL_LIST.*
              FROM (
        ]]>
        /* 구현 Sql */
		<![CDATA[
			SELECT a.HIST_ID				AS "histId"
			     , a.SYS_NM					AS "sysNm"
			     , c.CODE_NM 				AS "histSeCodeNm" 
			     , b.USER_NM 				AS "frstRegisterNm" 
			     , a.FRST_REGIST_PNTTM		AS "frstRegisterPnttm"
			  FROM COMTN_SYS_HIST a
				   LEFT OUTER JOIN COMVN_USER_MASTER b
						ON a.FRST_REGISTER_ID = b.ESNTL_ID
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM002') c
					   	ON a.HIST_SE_CODE = c.CODE
			 WHERE 1=1
		]]>
    	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "SYS_NM"'>
                 <![CDATA[ AND a.SYS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "CODE_NM"'>
                 <![CDATA[ AND c.CODE_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
	        </choose>
		</if>
		<![CDATA[
			 ORDER BY a.FRST_REGIST_PNTTM DESC
		]]>
        /* 구현 Sql */
        <![CDATA[
                   ) ALL_LIST
                   )
             WHERE RNUM BETWEEN #{searchVO.firstIndex} + 1 AND #{searchVO.firstIndex} + #{searchVO.recordPerPage}
        ]]>			
	</select>

	<select id="selectSysHistoryListCnt"  resultType="int">
		<![CDATA[
			SELECT COUNT(a.HIST_ID) as cnt
			  FROM COMTN_SYS_HIST a
				   LEFT OUTER JOIN COMVN_USER_MASTER b
						ON a.FRST_REGISTER_ID = b.ESNTL_ID
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM002') c
					   	ON a.HIST_SE_CODE = c.CODE
			 WHERE 1=1
		]]>
    	<if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "SYS_NM"'>
                 <![CDATA[ AND a.SYS_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "CODE_NM"'>
                 <![CDATA[ AND c.CODE_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
	        </choose>
		</if>
	</select>

	<select id="selectSysHistory" resultType="sysHistoryVO">
		<![CDATA[
			SELECT a.HIST_ID				
			     , a.SYS_NM					
			     , c.CODE 					AS "histSeCode"		
			     , c.CODE_NM 				AS "histSeCodeNm"		
			     , a.HIST_CN				
			     , b.USER_NM 				AS "frstRegisterNm"		
			     , a.FRST_REGIST_PNTTM		AS "frstRegisterPnttm"
			     , a.ATCH_FILE_ID			
			  FROM COMTN_SYS_HIST a
				   LEFT OUTER JOIN COMVN_USER_MASTER b
						ON a.FRST_REGISTER_ID = b.ESNTL_ID
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM002') c
					   	ON a.HIST_SE_CODE = c.CODE
			 WHERE a.HIST_ID = #{histId}
		]]>
	</select>

	<insert id="insertSysHistory" >
		<![CDATA[
			INSERT INTO COMTN_SYS_HIST ( 
					SYS_NM
				  , HIST_SE_CODE
				  , HIST_CN
				  , HIST_ID
				  , ATCH_FILE_ID
				  , FRST_REGISTER_ID
				  , FRST_REGIST_PNTTM 
			) VALUES ( 
					#{sysNm}
				  , #{histSeCode}
				  , #{histCn, jdbcType=VARCHAR}
				  , #{histId}
				  , #{atchFileId, jdbcType=VARCHAR}
				  , #{frstRegisterId}
				  , SYSDATE
			)
		]]>
	</insert>

	<update id="updateSysHistory">
		<![CDATA[
			UPDATE COMTN_SYS_HIST
			   SET SYS_NM 			= #{sysNm}
				 , HIST_SE_CODE 	= #{histSeCode}
				 , HIST_CN 			= #{histCn, jdbcType=VARCHAR}
				 , ATCH_FILE_ID 	= #{atchFileId, jdbcType=VARCHAR}
			 WHERE HIST_ID = #{histId}
		]]>
	</update>

	<delete id="deleteSysHistory" >
		<![CDATA[
			DELETE 
			  FROM COMTN_SYS_HIST
			 WHERE HIST_ID = #{histId}
		]]>
	</delete>

</mapper>