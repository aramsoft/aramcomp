<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.ion.ism.dao.InfrmlSanctnMapper">

	<select id="selectSanctnerList" resultType="egovMap">
        /* 구현 Sql */
       	<![CDATA[
			SELECT b.ORGNZT_NM				AS "orgnztNm"
			     , a.ESNTL_ID				AS "uniqId"
			     , a.USER_NM				AS "emplyrNm"
			     , a.EMPL_NO				AS "emplNo"
			     , a.OFCPS_NM				AS "ofcpsNm"
			  FROM COMTN_EMPLYR_INFO a
				   LEFT OUTER JOIN COMTN_ORGNZT_INFO b
						ON a.ORGNZT_ID = b.ORGNZT_ID
			 WHERE 1=1
		]]>
    	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "ORGNZT_NM"'>
                <![CDATA[ AND COALESCE(b.ORGNZT_NM, ' ') LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "USER_NM"'>
                <![CDATA[ AND COALESCE(a.USER_NM, ' ') LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
		<![CDATA[
			 ORDER BY b.ORGNZT_NM, a.USER_NM ASC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{recordPerPage} OFFSET #{firstIndex}
        ]]>			
	</select>	
	
	<select id="selectSanctnerListCnt" resultType="int" >
		<![CDATA[
			SELECT COUNT(EMPLYR_ID) as cnt
			  FROM COMTN_EMPLYR_INFO a
			       LEFT OUTER JOIN COMTN_ORGNZT_INFO b
						ON a.ORGNZT_ID = b.ORGNZT_ID
			 WHERE 1=1
		]]>
    	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "ORGNZT_NM"'>
                <![CDATA[ AND COALESCE(b.ORGNZT_NM, ' ') LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "USER_NM"'>
                <![CDATA[ AND COALESCE(a.USER_NM, ' ') LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	</select>
	
	<!-- 약식결재::상세보기 -->
	<select id="selectInfrmlSanctn"  resultType="infrmlSanctnVO" >
		<![CDATA[
			SELECT A.INFRML_SANCTN_ID
			     , A.JOB_SE_CODE
			     , B.CODE_NM 				AS "jobSeNm"
			     , A.APPLCNT_ID
			     , C.USER_NM 				AS "applcntNm"
			     , A.REQST_DE
			     , A.SANCTNER_ID
			     , D.USER_NM 				AS "sanctnerNm"
			     , E.ORGNZT_NM 				AS "sanctnerOrgnztNm"
			     , A.CONFM_AT
			     , A.SANCTN_DT
			     , A.RETURN_RESN
			  FROM COMTN_INFRML_SANCTN A
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM075') B
				       	ON A.JOB_SE_CODE = B.CODE
				   LEFT OUTER JOIN COMTN_EMPLYR_INFO C
						ON A.APPLCNT_ID = C.ESNTL_ID
				   LEFT OUTER JOIN COMTN_EMPLYR_INFO D
						ON A.SANCTNER_ID = D.ESNTL_ID
				   LEFT OUTER JOIN COMTN_ORGNZT_INFO E
					    ON D.ORGNZT_ID = E.ORGNZT_ID
			 WHERE A.INFRML_SANCTN_ID = #{infrmlSanctnId}
		]]>
	</select>
	
	<insert id="insertInfrmlSanctn" >
		<![CDATA[
			INSERT INTO COMTN_INFRML_SANCTN (
					INFRML_SANCTN_ID
				  , JOB_SE_CODE
				  , APPLCNT_ID
				  , REQST_DE
				  , SANCTNER_ID
				  , CONFM_AT
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			) VALUES ( 
					#{infrmlSanctnId}
				  , #{jobSeCode}
				  , #{applcntId}
				  , #{reqstDe}
				  , #{sanctnerId}
				  , #{confmAt}
				  , #{frstRegisterId}
				  , now()
				  , #{frstRegisterId} 
				  , now()
			)
		]]>
	</insert>
	
	<update id="updateInfrmlSanctn" >
		<![CDATA[
			UPDATE COMTN_INFRML_SANCTN
			   SET SANCTNER_ID 		= #{sanctnerId}
			     , LAST_UPDUSR_ID 	= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM 	= now()
			 WHERE INFRML_SANCTN_ID = #{infrmlSanctnId}
		]]>			
	</update>
	
	<update id="updateInfrmlSanctnConfm" >
		<![CDATA[
			UPDATE COMTN_INFRML_SANCTN
			   SET CONFM_AT 		= #{confmAt}
			     , SANCTN_DT 		= now()
			     , RETURN_RESN 		= #{returnResn}
			     , LAST_UPDUSR_ID 	= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM 	= now()
			 WHERE INFRML_SANCTN_ID = #{infrmlSanctnId}
		]]>			
	</update>
	
	<delete id="deleteInfrmlSanctn" >
		<![CDATA[
			DELETE 
			  FROM COMTN_INFRML_SANCTN
			 WHERE INFRML_SANCTN_ID = #{infrmlSanctnId}
		]]>			
	</delete>
	
</mapper>
