<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.ion.ntm.dao.NoteManageMapper">

	<!-- 쪽지관리::쪽지관리 조회(답변처리시) -->
	<select id="selectNoteManage" resultType="egovMap">
	 	<![CDATA[
			 SELECT A.NOTE_ID				
			 	  , (SELECT TRNSMITER_ID 
			 	       FROM COMTN_NOTE_TRNSMIT 
			 	      WHERE NOTE_ID = A.NOTE_ID 
			 	        AND ROWNUM <= 1
			 	    ) 						AS "trnsmiterOrgId" 
			 	  ,	(SELECT USER_NM 
			 	       FROM COMTN_EMPLYR_INFO 
			 	      WHERE ESNTL_ID = (SELECT TRNSMITER_ID 
			 	      		              FROM COMTN_NOTE_TRNSMIT 
			 	      		             WHERE NOTE_ID = A.NOTE_ID 
			 	      		               AND ROWNUM <= 1)
			 	    ) 						AS "trnsmiterNm"	
			 	  , (SELECT EMPLYR_ID 
			 	       FROM COMTN_EMPLYR_INFO 
			 	      WHERE ESNTL_ID = (SELECT TRNSMITER_ID 
			 	      				      FROM COMTN_NOTE_TRNSMIT 
			 	      				     WHERE NOTE_ID = A.NOTE_ID 
			 	      				       AND ROWNUM <= 1)
			 	    ) 						AS "trnsmiterId" 
			 	  , TO_CHAR((SELECT FRST_REGIST_PNTTM 
			 	  			   FROM COMTN_NOTE_TRNSMIT 
			 	  			  WHERE NOTE_ID = A.NOTE_ID 
			 	  			    AND ROWNUM <= 1),'YYYY-MM-DD HH24:MI:SS') AS "trnsmiterPnttm" 
			 	  , A.NOTE_SJ				AS "noteSj"
			 	  ,	A.NOTE_CN				AS "noteCn"
			   FROM COMTN_NOTE A
			  WHERE A.NOTE_ID = #{noteId} 
		]]>
	</select>
	
	<!-- 쪽지관리::쪽지관리  등록  -->
	<insert id="insertNoteManage">	     
	 	<![CDATA[ 
			INSERT INTO COMTN_NOTE ( 
					NOTE_ID
				  , NOTE_SJ
				  ,	NOTE_CN
				  , ATCH_FILE_ID
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			) VALUES (
					#{noteId}
				  ,	#{noteSj}
				  ,	#{noteCn}
				  ,	#{atchFileId, jdbcType=VARCHAR}
				  , #{frstRegisterId}
				  , SYSDATE
				  , #{frstRegisterId} 
				  , SYSDATE
			)
	 	]]>
	</insert>

	<!-- 쪽지관리::보낸쪽지  등록  -->
	<insert id="insertNoteTrnsmit">	     
	 	<![CDATA[
			INSERT INTO COMTN_NOTE_TRNSMIT ( 
					NOTE_ID
				  ,	NOTE_TRNSMIT_ID
				  ,	TRNSMITER_ID
				  ,	DELETE_AT
				  ,	FRST_REGISTER_ID
				  ,	FRST_REGIST_PNTTM
				  ,	LAST_UPDUSR_ID
				  ,	LAST_UPDT_PNTTM
			) VALUES (
					#{noteId}
				  ,	#{noteTrnsmitId}
				  ,	#{trnsmiterId}
				  ,	'N'
				  , #{frstRegisterId}
				  , SYSDATE
				  , #{frstRegisterId} 
				  , SYSDATE
			)
		]]>
	</insert>

	<!-- 쪽지관리::받은쪽지  등록  -->
	<insert id="insertNoteRecptn">	     
		<![CDATA[
			INSERT INTO COMTN_NOTE_RECPTN(
					NOTE_ID
				  ,	NOTE_TRNSMIT_ID
				  ,	NOTE_RECPTN_ID
				  ,	RCVER_ID
				  ,	OPEN_YN
				  ,	RECPTN_SE
				  ,	FRST_REGISTER_ID
				  ,	FRST_REGIST_PNTTM
				  ,	LAST_UPDUSR_ID
				  ,	LAST_UPDT_PNTTM
			) VALUES (
					#{noteId}
				  ,	#{noteTrnsmitId}
				  ,	#{noteRecptnId}
				  ,	#{rcverId}
				  ,	#{openYn}
				  , #{recptnSe}
				  , #{frstRegisterId}
				  , SYSDATE
				  , #{frstRegisterId} 
				  , SYSDATE
			)
		]]>
	</insert>
	
	<!-- 쪽지관리::아이디 검색  -->
	<select id="selectNoteEmpList" resultType="egovMap">
		<![CDATA[
            SELECT *
              FROM (
            SELECT ROWNUM RNUM, ALL_LIST.*
              FROM (
        ]]>
        /* 구현 Sql */
       	<![CDATA[
			SELECT EMPLYR_ID
				 , USER_NM 					EMPLYR_NM
				 , ESNTL_ID 				UNIQ_ID
				 , SEXDSTN_CODE
				 , BRTHDY
				 , HOUSE_ADRES 				HOME_ADRES
				 , DETAIL_ADRES
				 , EMAIL_ADRES
				 , OFFM_TELNO 
		      FROM COMTN_EMPLYR_INFO 
		     WHERE 1=1 
	 	]]>
   	    <if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "USER_NM"'>
               	<![CDATA[ AND USER_NM LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "EMPLYR_ID"'>
               	<![CDATA[ AND EMPLYR_ID LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "OFFM_TELNO"'>
               	<![CDATA[ AND OFFM_TELNO LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	 	<![CDATA[
		     ORDER BY USER_NM DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
                   ) ALL_LIST
                   )
             WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordPerPage}
        ]]>			
	</select>

	<select id="selectNoteEmpListCnt" resultType="int">
        <![CDATA[
			SELECT COUNT(*) totcnt
			  FROM COMTN_EMPLYR_INFO
			 WHERE 1=1 
        ]]>			
   	    <if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "USER_NM"'>
               	<![CDATA[ AND USER_NM LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "EMPLYR_ID"'>
               	<![CDATA[ AND EMPLYR_ID LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "OFFM_TELNO"'>
               	<![CDATA[ AND OFFM_TELNO LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	</select>
	
</mapper>