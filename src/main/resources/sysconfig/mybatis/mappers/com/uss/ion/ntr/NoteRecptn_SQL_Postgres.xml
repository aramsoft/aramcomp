<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.ion.ntr.dao.NoteRecptnMapper">
	
	<!-- 받은편지함관리::목록조회 게시물정보 -->
	<select id="selectNoteRecptnList" resultType="egovMap">
        /* 구현 Sql */
       	<![CDATA[
			SELECT NOTE.NOTE_ID				AS "noteId"
			     , NOTE_RNS.NOTE_TRNSMIT_ID	AS "noteTrnsmitId"
			     , NOTE_RNS.NOTE_RECPTN_ID	AS "noteRecptnId"
			     , NOTE.NOTE_SJ				AS "noteSj"
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_RNS.RCVER_ID
			       ) 						AS "rcverNm" 
			     , NOTE_RNS.FRST_REGIST_PNTTM	AS "frstRegisterPnttm"  
			  FROM COMTN_NOTE NOTE
			       LEFT OUTER JOIN COMTN_NOTE_TRNSMIT NOTE_TNS 
			       		ON  NOTE.NOTE_ID = NOTE_TNS.NOTE_ID    
			       LEFT OUTER JOIN COMTN_NOTE_RECPTN NOTE_RNS 
			       		ON  NOTE_TNS.NOTE_ID        =NOTE_RNS.NOTE_ID  
			          	AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
			 WHERE NOTE_RNS.RCVER_ID = #{rcverId}
		]]>
 	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "RCVER_ID"'>
				<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTN_EMPLYR_INFO WHERE EMPLYR_ID = #{searchVO.searchKeyword}) ]]>
            </when>
            <when test='searchVO.searchCondition == "RCVER_NM"'>
				<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTN_EMPLYR_INFO WHERE USER_NM =  #{searchVO.searchKeyword}) ]]>
            </when>
            <when test='searchVO.searchCondition == "NOTE_SJ"'>
               	<![CDATA[ AND NOTE.NOTE_SJ LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "NOTE_CN"'>
               	<![CDATA[ AND NOTE.NOTE_CN LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
    	<if test='searchFromDate != null and searchFromDate != ""'>
    		<if test='searchToDate != null and searchToDate != ""'>
	 			<![CDATA[ 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #{searchFromDate} 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #{searchToDate} 
	 			]]> 
	 		</if>
	 	</if>
		<![CDATA[
			 ORDER BY "frstRegisterPnttm" DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
	</select>

	<!-- 받은편지함관리::목록조회_게시물 총갯수  -->
	<select id="selectNoteRecptnListCnt" resultType="int">
        <![CDATA[
			SELECT COUNT(*) totcnt
		      FROM COMTN_NOTE NOTE
			       LEFT OUTER JOIN COMTN_NOTE_TRNSMIT NOTE_TNS 
			       		ON  NOTE.NOTE_ID = NOTE_TNS.NOTE_ID      
			       LEFT OUTER JOIN COMTN_NOTE_RECPTN NOTE_RNS 
			       		ON  NOTE_TNS.NOTE_ID        =NOTE_RNS.NOTE_ID 
			          	AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
			 WHERE NOTE_RNS.RCVER_ID = #{rcverId}
        ]]>			
 	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "RCVER_ID"'>
				<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTN_EMPLYR_INFO WHERE EMPLYR_ID = #{searchVO.searchKeyword}) ]]>
            </when>
            <when test='searchVO.searchCondition == "RCVER_NM"'>
				<![CDATA[ AND NOTE_RNS.RCVER_ID = (SELECT ESNTL_ID FROM COMTN_EMPLYR_INFO WHERE USER_NM =  #{searchVO.searchKeyword}) ]]>
            </when>
            <when test='searchVO.searchCondition == "NOTE_SJ"'>
               	<![CDATA[ AND NOTE.NOTE_SJ LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "NOTE_CN"'>
               	<![CDATA[ AND NOTE.NOTE_CN LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
    	<if test='searchFromDate != null and searchFromDate != ""'>
    		<if test='searchToDate != null and searchToDate != ""'>
	 			<![CDATA[ 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #{searchFromDate} 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #{searchToDate} 
	 			]]> 
	 		</if>
	 	</if>
	</select>
	
	<!-- 받은편지함관리::상세 게시물정보 -->
	<select id="selectNoteRecptnDetail" resultType="egovMap">
	 	<![CDATA[
			SELECT NOTE.NOTE_ID
			     , NOTE_RNS.NOTE_TRNSMIT_ID
			     , NOTE_RNS.NOTE_RECPTN_ID
			     , NOTE_TNS.TRNSMITER_ID
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_TNS.TRNSMITER_ID
			       ) 						TRNSMITER_NM
			     , TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD HH24:MI:SS') TRNSMITER_PNTTM
			     , NOTE.NOTE_SJ
			     , NOTE.NOTE_CN
			     , NOTE.ATCH_FILE_ID
			     , NOTE_RNS.RCVER_ID
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_RNS.RCVER_ID
			       ) 						RCVER_NM
			     , TO_CHAR(NOTE_RNS.FRST_REGIST_PNTTM,'YYYY-MM-DD HH24:MI:SS') RCVER_PNTTM
			     , NOTE_RNS.OPEN_YN
			     , NOTE_RNS.RECPTN_SE
			  FROM COMTN_NOTE NOTE
			       LEFT OUTER JOIN COMTN_NOTE_TRNSMIT NOTE_TNS 
			       		ON  NOTE.NOTE_ID = NOTE_TNS.NOTE_ID
			       LEFT OUTER JOIN COMTN_NOTE_RECPTN NOTE_RNS 
			       		ON  NOTE_TNS.NOTE_ID        =NOTE_RNS.NOTE_ID 
			       		AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID
			 WHERE NOTE.NOTE_ID = #{noteId} 
			   AMD NOTE_RNS.NOTE_ID = #{noteId}
			   AND NOTE_RNS.NOTE_TRNSMIT_ID = #{noteTrnsmitId}
			   AND NOTE_RNS.NOTE_RECPTN_ID = #{noteRecptnId}
		]]>
	</select>
	
	<!-- 받은편지함관리::개봉으로 업데이트 -->
	<update id="updateNoteRecptnRelationOpenYn">
	 	<![CDATA[
			UPDATE COMTN_NOTE_RECPTN 
			   SET OPEN_YN='Y'
			     , LAST_UPDUSR_ID = #{lastUpdusrId}
			     , LAST_UPDT_PNTTM = now()
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
			   AND NOTE_RECPTN_ID = #{noteRecptnId}
		]]>
	</update>
		
	<!-- 받은편지함관리::보낸편지함 갯수 조회  -->
	<select id="selectNoteTrnsmitRelationCnt" resultType="int">
	 	<![CDATA[
			SELECT COUNT(NOTE_ID) CNT
			  FROM COMTN_NOTE_TRNSMIT 
			 WHERE DELETE_AT='Y'
			   AND NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
		]]>
	</select>
	
	<!-- 받은편지함관리::받은편지함 갯수 조회  -->
	<select id="selectNoteRecptnRelationCnt" resultType="int">
	 	<![CDATA[
			SELECT COUNT(NOTE_ID) CNT
			  FROM COMTN_NOTE_RECPTN  
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
		]]>
	</select>
	
    <!-- 받은편지함관리::삭제  -->
	<delete id="deleteNoteRecptn">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE_RECPTN 
			 WHERE NOTE_ID = #{noteId} 
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId} 
			   AND NOTE_RECPTN_ID = #{noteRecptnId} 
		]]>
	</delete>
	
	<!-- 보낸쪽지함삭제::삭제  -->
	<delete id="deleteNoteTrnsmit">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE_TRNSMIT 
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId} 
		]]>
	</delete>
	
	<!-- 쪽지관리삭제::삭제  -->
	<delete id="deleteNoteManage">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE 
			 WHERE NOTE_ID = #{noteId}
		]]>
	</delete>
	
	<!-- 받은편지함관리::쪽지정보/보낸쪽지 삭제  -->
	<delete id="deleteNoteRecptnRelation">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE_RECPTN 
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId} 
			   AND NOTE_RECPTN_ID = #{noteRecptnId};
			
			DELETE 
			  FROM COMTN_NOTE_TRNSMIT
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId};
			
			DELETE 
			  FROM COMTN_NOTE 
			 WHERE NOTE_ID = #{noteId};
		]]>
	</delete>
	
</mapper>