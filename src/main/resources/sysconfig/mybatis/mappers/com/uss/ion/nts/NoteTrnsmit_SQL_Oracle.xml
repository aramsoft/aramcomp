<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.ion.nts.service.NoteTrnsmitMapper">

	<!-- 보낸편지함관리::수신자목록 -->
	
	<!-- 보낸편지함관리::목록조회 게시물정보 -->
	<select id="selectNoteTrnsmitList" resultType="egovMap">
		<![CDATA[
            SELECT *
              FROM (
            SELECT ROWNUM RNUM, ALL_LIST.*
              FROM (
        ]]>
        /* 구현 Sql */
       	<![CDATA[
			SELECT NOTE.NOTE_ID				AS "noteId"
			     , NOTE_TNS.NOTE_TRNSMIT_ID	AS "noteTrnsmitId"
			     , NOTE.NOTE_SJ				AS "noteSj"
			     , NOTE_TNS.FRST_REGIST_PNTTM 	AS "frstRegisterPnttm" 
			     , (SELECT (SELECT USER_NM 
			     			  FROM COMTN_EMPLYR_INFO 
			     			 WHERE ESNTL_ID = A.RCVER_ID)
		        	  FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		        	   AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID         
		        	   AND ROWNUM <= 1
		           ) 						AS "rcverNm" 
		         , (SELECT COUNT(A.NOTE_ID)
		              FROM COMTN_NOTE_RECPTN A
		        	 WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		        	   AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID        
		           )-1 						AS "rcverCnt" 
		         , (SELECT COUNT(A.NOTE_ID)
		              FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		        	   AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID 
		               AND A.OPEN_YN = 'Y'       
		           ) 						AS "openY" 
		         , (SELECT COUNT(A.NOTE_ID)
		              FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		               AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID 
		               AND A.OPEN_YN = 'N'       
		           ) 						AS "openN" 
			  FROM COMTN_NOTE NOTE
			     , COMTN_NOTE_TRNSMIT NOTE_TNS 
			 WHERE NOTE.NOTE_ID = NOTE_TNS.NOTE_ID 
			   AND NOTE_TNS.DELETE_AT = 'N' 
			   AND NOTE_TNS.TRNSMITER_ID = #{trnsmiterId}
		]]>
    	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "NOTE_SJ"'>
               	<![CDATA[ AND NOTE.NOTE_SJ LIKE '%'|| #{searchKeyword} ||'%' ]]> 
            </when>
            <when test='searchCondition == "NOTE_CN"'>
               	<![CDATA[ AND NOTE.NOTE_CN LIKE '%'|| #{searchKeyword} ||'%' ]]> 
            </when>
        </choose>
		</if>
    	<if test='searchFromDate != null and searchFromDate != ""'>
    		<if test='searchToDate != null and searchToDate != ""'>
	 			<![CDATA[ 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #{searchFromDate} 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #{searchToDate} 
	 			]]> 
	 		</if>
	 	</if>
		<![CDATA[
			 ORDER BY NOTE.FRST_REGIST_PNTTM DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
                   ) ALL_LIST
                   )
             WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordPerPage}
        ]]>			
	</select>

	<!-- 보낸편지함관리::목록조회_게시물 총갯수  -->
	<select id="selectNoteTrnsmitListCnt" resultType="int">
        <![CDATA[
			SELECT COUNT(*) totcnt
			  FROM COMTN_NOTE NOTE
			     , COMTN_NOTE_TRNSMIT NOTE_TNS 
			 WHERE NOTE.NOTE_ID = NOTE_TNS.NOTE_ID 
			   AND NOTE_TNS.DELETE_AT = 'N' 
			   AND NOTE_TNS.TRNSMITER_ID = #{trnsmiterId}
 		]]>				
    	<if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "NOTE_SJ"'>
               	<![CDATA[ AND NOTE.NOTE_SJ LIKE '%'|| #{searchKeyword} ||'%' ]]> 
            </when>
            <when test='searchCondition == "NOTE_CN"'>
               	<![CDATA[ AND NOTE.NOTE_CN LIKE '%'|| #{searchKeyword} ||'%' ]]> 
            </when>
        </choose>
		</if>
    	<if test='searchFromDate != null and searchFromDate != ""'>
    		<if test='searchToDate != null and searchToDate != ""'>
	 			<![CDATA[ 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') >= #{searchFromDate} 
	 		   		AND TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD') <= #{searchToDate} 
	 			]]> 
	 		</if>
	 	</if>
	</select>
	
	<!-- 보낸편지함관리::상세 게시물정보 -->
	<select id="selectNoteTrnsmitDetail" resultType="egovMap">
	 	<![CDATA[
			SELECT NOTE.NOTE_ID
			     , NOTE_TNS.NOTE_TRNSMIT_ID
			     , NOTE_TNS.TRNSMITER_ID
			     , NOTE.NOTE_SJ
			     , NOTE.NOTE_CN
			     , NOTE.ATCH_FILE_ID
			     , TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD HH24:MI:SS') AS "trnsmiterPnttm" 
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_TNS.FRST_REGISTER_ID
			       ) 						FRST_REGISTER_NM
			     , (SELECT (SELECT USER_NM 
			                  FROM COMTN_EMPLYR_INFO 
			                 WHERE ESNTL_ID = A.RCVER_ID)
		              FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		               AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID         
		               AND ROWNUM <= 1
		           ) 						RCVER_NM
		         , (SELECT COUNT(A.NOTE_ID)
		              FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		               AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID        
		           ) 						RCVER_TOTAL
		         , (SELECT COUNT(A.NOTE_ID)
		              FROM COMTN_NOTE_RECPTN A
		             WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		        	   AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID 
		        	   AND A.OPEN_YN = 'Y'       
		           ) 						OPEN_Y
		         , (SELECT COUNT(A.NOTE_ID)
		        	  FROM COMTN_NOTE_RECPTN A
		        	 WHERE A.NOTE_ID=NOTE_TNS.NOTE_ID
		        	   AND A.NOTE_TRNSMIT_ID=NOTE_TNS.NOTE_TRNSMIT_ID 
		        	   AND A.OPEN_YN = 'N'       
		           ) 						OPEN_N
		      FROM COMTN_NOTE NOTE
		         , COMTN_NOTE_TRNSMIT NOTE_TNS 
			 WHERE NOTE.NOTE_ID = NOTE_TNS.NOTE_ID 
			   AND NOTE_TNS.NOTE_ID = #{noteId}
			   AND NOTE_TNS.NOTE_TRNSMIT_ID = #{noteTrnsmitId} 
		]]>
	</select>
	
    <!-- 보낸편지함관리::받은편지함 삭제  -->
	<delete id="deleteNoteTrnsmit">
		<![CDATA[
			UPDATE COMTN_NOTE_TRNSMIT 
			   SET DELETE_AT		= 'Y'
			     , LAST_UPDUSR_ID 	= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM 	= SYSDATE
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
		]]>
	</delete>
	
    <!-- 보낸편지함관리::보낸편지함 삭제  -->
	<delete id="deleteNoteRecptn">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE_RECPTN 
		 	 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId} 
			   AND NOTE_RECPTN_ID = #{noteRecptnId} 
		]]>
	</delete>
	
	<!-- 보낸편지함관리::쪽지정보/보낸쪽지 삭제  -->
	<delete id="deleteNoteManage">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE 
			 WHERE NOTE_ID = #{noteId}
		]]>
	</delete>
	
	<!-- 보낸편지함관리::받은편지함 갯수  -->
	<select id="selectTrnsmitRelationCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(NOTE_ID) CNT
			  FROM COMTN_NOTE_RECPTN
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
		]]>
	</select>
	
	<!-- 보낸편지함관리::쪽지정보/보낸쪽지 삭제  -->
	<delete id="deleteNoteTrnsmitRelation">
		<![CDATA[
			DELETE 
			  FROM COMTN_NOTE_TRNSMIT
			 WHERE NOTE_ID = #{noteId}
			   AND NOTE_TRNSMIT_ID = #{noteTrnsmitId}
		]]>
	</delete>
	
	<!-- 보낸편지함관리::수신자목록조회 -->
	<select id="selectNoteTrnsmitCnfirm" resultType="egovMap">
	 	<![CDATA[
			SELECT NOTE.NOTE_ID				AS "noteId"
			     , NOTE_RNS.NOTE_TRNSMIT_ID	AS "noteTrnsmitId"
			     , NOTE_RNS.NOTE_RECPTN_ID	AS "noteRecptnId"
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_TNS.TRNSMITER_ID
			       ) 						AS "trnsmiterNm" 
			     , (SELECT EMPLYR_ID 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_TNS.TRNSMITER_ID
			       ) 						AS "trnsmiterIds" 
			     , TO_CHAR(NOTE_TNS.FRST_REGIST_PNTTM,'YYYY-MM-DD HH24:MI:SS') AS "trnsmiterPnttm" 
			     , NOTE.NOTE_SJ				AS "noteSj"
			     , (SELECT EMPLYR_ID 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_RNS.RCVER_ID
			       ) 						AS "rcverIds"
			     , (SELECT USER_NM 
			          FROM COMTN_EMPLYR_INFO 
			         WHERE ESNTL_ID = NOTE_RNS.RCVER_ID
			       ) 						AS "rcverNm" 
			     , TO_CHAR(NOTE_RNS.LAST_UPDT_PNTTM,'YYYY-MM-DD HH24:MI:SS') AS "rcverPnttm" 
			     , NOTE_RNS.OPEN_YN			AS "openYn"
			     , NOTE_RNS.RECPTN_SE		AS "recptnSe"
			  FROM COMTN_NOTE NOTE
			       LEFT OUTER JOIN COMTN_NOTE_TRNSMIT NOTE_TNS 
			       		ON  NOTE.NOTE_ID=NOTE_TNS.NOTE_ID      
			       LEFT OUTER JOIN COMTN_NOTE_RECPTN NOTE_RNS 
			       		ON  NOTE_TNS.NOTE_ID=NOTE_RNS.NOTE_ID  
			          	AND NOTE_TNS.NOTE_TRNSMIT_ID=NOTE_RNS.NOTE_TRNSMIT_ID      
			 WHERE NOTE.NOTE_ID = #{noteId}
		]]>
	</select>
	
</mapper>