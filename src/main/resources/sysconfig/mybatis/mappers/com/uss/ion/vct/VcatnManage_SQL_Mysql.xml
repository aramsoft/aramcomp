<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.ion.vct.dao.VcatnManageMapper">

    <select id="selectVcatnManageList" resultType="egovMap">
        /* 구현 Sql */
       	<![CDATA[
			SELECT APPLCNT_ID          		AS "applcntId"        
			     , VCATN_SE            		AS "vcatnSe"          
			     , VCATN_RESN          		AS "vcatnResn"        
			     , SANCTNER_ID         		AS "sanctnerId"       
			     , (select mst.USER_NM 
			          from COMVN_USER_MASTER mst 
			         where mst.ESNTL_ID = SANCTNER_ID
			       )  						AS "sanctnerNm"
			     , CONFM_AT            		AS "confmAt"          
			     , BGNDE               		AS "bgnde"            
			     , ENDDE               		AS "endde"            
			     , (select code_nm 
			          from COMTC_CMMN_DETAIL_CODE 
			         where code_id ='COM056' 
			           and code = A.VCATN_SE
			       ) 						AS "vcatnSeNm"
			  FROM COMTN_VCATN_MANAGE A  
			 WHERE BGNDE like  '%'||#{searchVO.searchKeyword}||'%'
			   AND APPLCNT_ID = #{applcntId}
			 ORDER BY FRST_REGIST_PNTTM DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
    </select> 

    <select id="selectVcatnManageListCnt" resultType="int">
        <![CDATA[
            SELECT COUNT(*) totcnt
              FROM COMTN_VCATN_MANAGE
             WHERE 1=1
			   AND BGNDE like  '%'||#{searchVO.searchKeyword}||'%'
			   AND APPLCNT_ID = #{applcntId}
        ]]>
    </select>

    <select id="selectVcatnManage" resultType="vcatnManageVO">
        <![CDATA[
			SELECT APPLCNT_ID          		AS "applcntId"        
                 , VCATN_SE            		AS "vcatnSe"          
                 , BGNDE               		AS "bgnde"            
                 , ENDDE               		AS "endde"            
                 , REQST_DE            		AS "reqstDe"          
                 , OCCRRNC_YEAR        		AS "occrrncYear"      
                 , VCATN_RESN          		AS "vcatnResn"		   
                 , SANCTNER_ID         		AS "sanctnerId"       
                 , CONFM_AT            		AS "confmAt"          
                 , SANCTN_DT           		AS "sanctnDt"         
                 , RETURN_RESN         		AS "returnResn"       
			     , INFRML_SANCTN_ID    		AS "infrmlSanctnId"   
			     , mst.user_nm         		AS "applcntNm"        
			     , org.orgnzt_nm       		AS "orgnztNm"         
	             , NOON_SE             		AS "noonSe"           
			     , (select code_nm 
			          from COMTC_CMMN_DETAIL_CODE 
			         where code_id ='COM056' 
			           and code = vct.VCATN_SE
			       ) 						as "vcatnSeNm"
			     , (select mst_a.USER_NM 
			          from COMVN_USER_MASTER mst_a 
			         where mst_a.ESNTL_ID = vct.SANCTNER_ID
			       )  						AS "sanctnerNm"
                 , (select info.ORGNZT_NM 
                      from COMVN_USER_MASTER mst_b
                         , COMTN_ORGNZT_INFO info 
                     where info.ORGNZT_ID = mst_b.ORGNZT_ID 
                       and mst_b.esntl_id= vct.SANCTNER_ID
                   ) 						AS "sanctnerOrgnztNm"
			  FROM COMTN_VCATN_MANAGE vct
				   LEFT OUTER JOIN COMVN_USER_MASTER mst
				        ON vct.APPLCNT_ID = mst.esntl_id
				   LEFT OUTER JOIN COMTN_ORGNZT_INFO org 
				        ON mst.orgnzt_id  = org.orgnzt_id
			 WHERE APPLCNT_ID     = #{applcntId}
			   AND VCATN_SE       = #{vcatnSe}
			   AND BGNDE		  = #{bgnde}
			   AND ENDDE		  = #{endde}
        ]]>
    </select>

    <insert id="insertVcatnManage" >
        <![CDATA[
            INSERT INTO COMTN_VCATN_MANAGE (
            		APPLCNT_ID         
                  , VCATN_SE           
                  , BGNDE              
                  , ENDDE              
                  , VCATN_RESN         
                  , REQST_DE           
                  , OCCRRNC_YEAR       
                  , NOON_SE            
                  , SANCTNER_ID        
                  , CONFM_AT            
                  , INFRML_SANCTN_ID       
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
            ) VALUES (
            		#{applcntId}  
                  , #{vcatnSe}    
                  , #{bgnde}     
                  , #{endde} 
                  , #{vcatnResn}
                  , #{reqstDe}
                  , #{occrrncYear}
                  , #{noonSe, jdbcType=VARCHAR}     
                  , #{sanctnerId}  
                  , #{confmAt} 
                  , #{infrmlSanctnId}   
				  , #{frstRegisterId}
				  , sysdate()
				  , #{frstRegisterId} 
				  , sysdate()
            )
        ]]>
    </insert>     

    <update id="updateVcatnManage" >
        <![CDATA[
            UPDATE COMTN_VCATN_MANAGE
               SET VCATN_RESN         = #{vcatnResn}  
				 , LAST_UPDUSR_ID     = #{lastUpdusrId}
                 , LAST_UPDT_PNTTM    = sysdate()    
             WHERE APPLCNT_ID         = #{applcntId}
			   AND VCATN_SE           = #{vcatnSe}
			   AND BGNDE			  = #{bgnde}
			   AND ENDDE			  = #{endde}
        ]]>
    </update>    
    
    <delete id="deleteVcatnManage" >
        <![CDATA[
             DELETE 
               FROM COMTN_VCATN_MANAGE
              WHERE APPLCNT_ID    = #{applcntId}
			    AND VCATN_SE      = #{vcatnSe}
			    AND BGNDE		  = #{bgnde}
			    AND ENDDE		  = #{endde}
        ]]>
    </delete>  

	<!-- 휴가일자 중복여부 체크 -->
    <select id="selectVcatnManageDplctAt"  resultType="int">
        <![CDATA[
            SELECT COUNT(*) totcnt
              FROM COMTN_VCATN_MANAGE
             WHERE CONFM_AT !='R'
               AND APPLCNT_ID = #{applcntId}
               AND #{searchVO.searchKeyword} BETWEEN BGNDE and ENDDE
        ]]>
    </select>

	<!-- 휴가 승인관련  -->
    <select id="selectVcatnManageConfmList" resultType="egovMap">
        /* 구현 Sql */
      	<![CDATA[
			SELECT A.APPLCNT_ID         	AS "applcntId"        
                 , mst.USER_NM        		AS "applcntNm"        
			     , (select info.ORGNZT_NM 
			          from COMTN_ORGNZT_INFO info 
			         where info.ORGNZT_ID = mst.ORGNZT_ID 
			       ) 						AS "orgnztNm"
                 , A.VCATN_SE           	AS "vcatnSe"          
			     , (select code_nm 
			          from COMTC_CMMN_DETAIL_CODE 
			         where code_id ='COM056' 
			           and code = A.VCATN_SE
			       ) 						as "vcatnSeNm"
                 , A.CONFM_AT           	AS "confmAt"          
                 , A.BGNDE             	 	AS "bgnde"            
                 , A.ENDDE              	AS "endde"            
			     , A.INFRML_SANCTN_ID   	AS "infrmlSanctnId"   
		      FROM COMTN_VCATN_MANAGE A
				   LEFT OUTER JOIN COMVN_USER_MASTER mst
				        ON A.APPLCNT_ID = mst.ESNTL_ID
			 WHERE A.SANCTNER_ID = #{sanctnerId}
        ]]>
    	<if test='searchNm != null and searchNm != ""'>
        		<![CDATA[ AND mst.USER_NM like '%'||#{searchNm}||'%' ]]>
		</if>
  	    <if test='searchConfmAt != null and searchConfmAt != ""'>
        		<![CDATA[ AND A.CONFM_AT like '%'||#{searchConfmAt}||'%' ]]>
		</if>
	    <choose>
            <when test='searchMonth != null and searchMonth != ""'>
	   			<![CDATA[ AND #{searchVO.searchKeyword} BETWEEN SUBSTR(A.BGNDE,0,6) AND SUBSTR(A.ENDDE,0,6)  ]]>
            </when>
            <otherwise>
	     	    <if test='searchYear != null and searchYear != ""'>
			    <![CDATA[ AND A.BGNDE like '%'||#{searchVO.searchKeyword}||'%'    ]]>
	 			</if>
            </otherwise>
        </choose>
        <![CDATA[
			 ORDER BY A.FRST_REGIST_PNTTM DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
    </select> 

    <select id="selectVcatnManageConfmListCnt" resultType="int">
        <![CDATA[
            SELECT COUNT(*) totcnt
		      FROM COMTN_VCATN_MANAGE A
				   LEFT OUTER JOIN COMVN_USER_MASTER mst
				        ON A.APPLCNT_ID = mst.ESNTL_ID
			 WHERE A.SANCTNER_ID = #{sanctnerId}
        ]]>
    	<if test='searchNm != null and searchNm != ""'>
        		<![CDATA[ AND mst.USER_NM like '%'||#{searchNm}||'%' ]]>
		</if>
  	    <if test='searchConfmAt != null and searchConfmAt != ""'>
        		<![CDATA[ AND A.CONFM_AT like '%'||#{searchConfmAt}||'%' ]]>
		</if>
	    <choose>
            <when test='searchMonth != null and searchMonth != ""'>
	   			<![CDATA[ AND #{searchVO.searchKeyword} BETWEEN SUBSTR(A.BGNDE,0,6) AND SUBSTR(A.ENDDE,0,6)  ]]>
            </when>
            <otherwise>
	     	    <if test='searchYear != null and searchYear != ""'>
			    <![CDATA[ AND A.BGNDE like '%'||#{searchVO.searchKeyword}||'%'    ]]>
	 			</if>
            </otherwise>
        </choose>
     </select>

    <update id="updateVcatnManageConfm" >
        <![CDATA[
            UPDATE COMTN_VCATN_MANAGE
               SET CONFM_AT           = #{confmAt}   
                 , SANCTN_DT          = STR_TO_DATE(#{sanctnDt}, '%Y-%m-%d %H:%i:%S')
                 , RETURN_RESN        = #{returnResn}  
				 , LAST_UPDUSR_ID     = #{lastUpdusrId}
                 , LAST_UPDT_PNTTM    = sysdate()    
             WHERE APPLCNT_ID         = #{applcntId}
			   AND VCATN_SE           = #{vcatnSe}
			   AND BGNDE			  = #{bgnde}
			   AND ENDDE			  = #{endde}
        ]]>
    </update>  

	<!-- 휴가 연차테이블 관련  -->
    <select id="selectIndvdlYrycManage" resultType="indvdlYrycManageVO">
        <![CDATA[
			SELECT OCCRRNC_YEAR    			AS "occrrncYear" 
			     , USER_ID         			AS "usid"        
			     , YRYC_OCCRRNC_CO 			AS "occrncYrycCo"
			     , USE_YRYC_CO     			AS "useYrycCo"   
			     , REMNDR_YRYC_CO  			AS "remndrYrycCo"
			  FROM COMTN_INDVDL_YRYC_MANAGE
			 WHERE OCCRRNC_YEAR 	= #{occrrncYear}
			   AND USER_ID         	= #{usid}
        ]]>
    </select>

    <update id="updateIndvdlYrycManage" >
        <![CDATA[
            UPDATE COMTN_INDVDL_YRYC_MANAGE
               SET USE_YRYC_CO      = #{useYrycCo}  
                 , REMNDR_YRYC_CO   = #{remndrYrycCo}  
				 , LAST_UPDUSR_ID   = #{lastUpdusrId}
                 , LAST_UPDT_PNTTM  = sysdate()    
			 WHERE OCCRRNC_YEAR 	= #{occrrncYear}
			   AND USER_ID         	= #{usid}
        ]]>
    </update>  

</mapper>