<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.olp.cns.dao.CnsltManageMapper">

	<select id="selectCnsltList" resultType="egovMap">
        /* 구현 Sql */
       <![CDATA[
      		SELECT C.CNSLT_ID				AS "cnsltId"
      			 , C.CNSLT_SJ				AS "cnsltSj"
      			 , C.WRTER_NM 				AS "wrterNm"
      			 , C.WRITNG_DE				AS "writngDe"
      			 , C.RDCNT					AS "inqireCo" 
      			 , D.CODE_NM 				AS "qnaProcessSttusCodeNm" 
		      FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
		     WHERE 1=1
		]]>
    	<if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND C.TRGET_ID = #{trgetId} ]]>
		</if>
     	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "WRTER_NM"'>
                <![CDATA[ AND C.WRTER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "CNSLT_SJ"'>
                <![CDATA[ AND C.CNSLT_SJ LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
		<![CDATA[
			 ORDER BY C.CNSLT_SJ DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
	</select>

	<select id="selectCnsltListCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*) totcnt
		      FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
			 WHERE 1=1
		]]>
    	<if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND C.TRGET_ID = #{trgetId} ]]>
		</if>
     	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "WRTER_NM"'>
                <![CDATA[ AND C.WRTER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "CNSLT_SJ"'>
                <![CDATA[ AND C.CNSLT_SJ LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	</select>

	<select id="selectCnsltListDetail" resultType="cnsltManageVO">
		<![CDATA[
			SELECT C.CNSLT_ID
			     , C.CNSLT_SJ
			     , C.CNSLT_CN
			     , C.OTHBC_AT
			     , C.WRITNG_PASSWORD
			     , C.AREA_NO
			     , C.MIDDLE_TELNO
			     , C.END_TELNO
			     , C.FRST_MBTLNUM			AS "firstMoblphonNo"
			     , C.MIDDLE_MBTLNUM
			     , C.END_MBTLNUM
			     , C.EMAIL_ADRES
			     , C.EMAIL_ANSWER_AT
			     , C.WRTER_NM 
			     , C.WRITNG_DE
			     , C.RDCNT					AS "inqireCo"
			     , C.QNA_PROCESS_STTUS_CODE
			     , D.CODE_NM 				AS "qnaProcessSttusCodeNm" 
			     , C.MANAGT_CN
			     , C.MANAGT_DE 
			     , C.ATCH_FILE_ID
			     , A.USER_NM				AS "emplyrNm"
			     , A.OFFM_TELNO
			     , A.EMAIL_ADRES 			AS "aemailAdres"
			     , B.ORGNZT_NM 
			     , C.FRST_REGIST_PNTTM 		AS "frstRegisterPnttm"
			     , C.FRST_REGISTER_ID
			     , C.LAST_UPDT_PNTTM 		AS "lastUpdusrPnttm"	    
			     , C.LAST_UPDUSR_ID
			  FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
				   LEFT OUTER JOIN COMTN_EMPLYR_INFO A     
						ON A.ESNTL_ID= C.LAST_UPDUSR_ID
				   LEFT OUTER JOIN COMTN_ORGNZT_INFO B     
						ON A.ORGNZT_ID = B.ORGNZT_ID
			 WHERE CNSLT_ID = #{cnsltId}
		]]>
	</select>

	<insert id="insertCnsltDtls">
		<![CDATA[
			INSERT INTO COMTN_CNSLT_INFO (
					CNSLT_ID
				  , CNSLT_SJ
				  , CNSLT_CN
				  , OTHBC_AT
				  , WRITNG_PASSWORD
				  , AREA_NO
				  , MIDDLE_TELNO
				  , END_TELNO
				  , FRST_MBTLNUM
				  , MIDDLE_MBTLNUM
				  , END_MBTLNUM
				  , EMAIL_ADRES
				  , EMAIL_ANSWER_AT
				  , WRTER_NM
				  , WRITNG_DE
				  , RDCNT
				  , QNA_PROCESS_STTUS_CODE
				  , ATCH_FILE_ID
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			  	  ,	TRGET_ID
			) VALUES ( 
					#{cnsltId}
				  , #{cnsltSj}
				  , #{cnsltCn}
				  , #{othbcAt, jdbcType=VARCHAR}
				  , #{writngPassword}
				  , #{areaNo}
				  , #{middleTelno}
				  , #{endTelno}
				  , #{firstMoblphonNo}
				  , #{middleMbtlnum}
				  , #{endMbtlnum}
				  , #{emailAdres}
				  , COALESCE(#{emailAnswerAt, jdbcType=VARCHAR},'N')
				  , #{wrterNm}
				  , now()
				  , 0
				  , '1'
				  , #{atchFileId, jdbcType=VARCHAR}
				  , #{frstRegisterId}
				  , now()
				  , #{frstRegisterId}
				  , now()
			  	  ,	#{trgetId}
			)
		]]>
	</insert>

	<update id="updateCnsltInqireCo">
		<![CDATA[
			UPDATE COMTN_CNSLT_INFO	
			   SET RDCNT= COALESCE(RDCNT,0) + 1
 			 WHERE CNSLT_ID = #{cnsltId}
		]]>
	</update>

	<select id="selectCnsltPasswordConfirmCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*) totcnt
			  FROM COMTN_CNSLT_INFO
			 WHERE CNSLT_ID=#cnsltId#
			   AND WRITNG_PASSWORD = #{writngPassword}
		]]>
	</select>

	<update id="updateCnsltDtls">
		<![CDATA[
			UPDATE COMTN_CNSLT_INFO	
			   SET CNSLT_SJ			= #{cnsltSj}
				 , CNSLT_CN			= #{cnsltCn}
				 , OTHBC_AT			= #{othbcAt, jdbcType=VARCHAR}
				 , WRITNG_PASSWORD	= #{writngPassword}
				 , AREA_NO			= #{areaNo}
				 , MIDDLE_TELNO		= #{middleTelno}
				 , END_TELNO		= #{endTelno}
				 , FRST_MBTLNUM		= #{firstMoblphonNo}
				 , MIDDLE_MBTLNUM	= #{middleMbtlnum}
				 , END_MBTLNUM		= #{endMbtlnum}
				 , EMAIL_ADRES		= #{emailAdres}
				 , EMAIL_ANSWER_AT	= COALESCE(#{emailAnswerAt, jdbcType=VARCHAR},'N')
				 , WRTER_NM			= #{wrterNm}
				 , WRITNG_DE		= now()
				 , MANAGT_CN		= #{managtCn}
				 , MANAGT_DE		= #{managtDe}
				 , ATCH_FILE_ID		= #{atchFileId, jdbcType=VARCHAR}
                 , LAST_UPDUSR_ID   = #{lastUpdusrId}    
                 , LAST_UPDT_PNTTM  = now()    
			WHERE  CNSLT_ID = #{cnsltId}
		]]>
	</update>

	<delete id="deleteCnsltDtls">
		<![CDATA[
			DELETE 
			  FROM COMTN_CNSLT_INFO
			 WHERE CNSLT_ID=#{cnsltId}
		]]>
	</delete>

	<select id="selectCnsltAnswerList" resultType="egovMap">
        /* 구현 Sql */
       	<![CDATA[
   		    SELECT C.CNSLT_ID
   		         , C.CNSLT_SJ
   		         , C.WRTER_NM 
   		         , C.WRITNG_DE
   		         , C.RDCNT					INQIRE_CO
   		         , C.QNA_PROCESS_STTUS_CODE
   		         , D.CODE_NM 				QNA_PROCESS_STTUS_CODE_NM
		      FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
		     WHERE 1=1
		]]>
	    <if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND C.TRGET_ID = #{trgetId} ]]>
		</if> 
     	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "WRTER_NM"'>
                <![CDATA[ AND C.WRTER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "QNA_PROCESS_STTUS"'>
                <![CDATA[ AND D.CODE_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
		<![CDATA[
			 ORDER BY C.CNSLT_SJ DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
 			LIMIT  #{searchVO.recordPerPage} OFFSET #{searchVO.firstIndex}
        ]]>			
	</select>

	<select id="selectCnsltAnswerListCnt" resultType="int">
		<![CDATA[
			SELECT COUNT(*) totcnt
		      FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
			 WHERE 1=1
		]]>
	    <if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND C.TRGET_ID = #{trgetId} ]]>
		</if> 
     	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "WRTER_NM"'>
                <![CDATA[ AND C.WRTER_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "QNA_PROCESS_STTUS"'>
                <![CDATA[ AND D.CODE_NM LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
        </choose>
		</if>
	</select>

	<select id="selectCnsltAnswerDetail" resultType="cnsltManageVO">
		<![CDATA[
			SELECT C.CNSLT_ID
			     , C.CNSLT_SJ
			     , C.CNSLT_CN
			     , C.OTHBC_AT
			     , C.WRITNG_PASSWORD
			     , C.AREA_NO
			     , C.MIDDLE_TELNO
			     , C.END_TELNO
			     , C.FRST_MBTLNUM			AS "firstMoblphonNo"
			     , C.MIDDLE_MBTLNUM
			     , C.END_MBTLNUM
			     , C.EMAIL_ADRES
			     , C.EMAIL_ANSWER_AT
			     , C.WRTER_NM 
			     , C.WRITNG_DE
			     , C.RDCNT					AS "inqireCo"
			     , C.QNA_PROCESS_STTUS_CODE
			     , D.CODE_NM 				AS "qnaProcessSttusCodeNm"
			     , C.MANAGT_CN
			     , C.MANAGT_DE
			     , C.ATCH_FILE_ID
			     , A.USER_NM				AS "emplyrNm"
			     , A.OFFM_TELNO
			     , A.EMAIL_ADRES 			AS "aemailAdres"
			     , B.ORGNZT_NM 
			     , C.FRST_REGIST_PNTTM 		AS "frstRegisterPnttm"
			     , C.FRST_REGISTER_ID
			     , C.LAST_UPDT_PNTTM   		AS "lastUpdusrPnttm" 	    
			     , C.LAST_UPDUSR_ID
			  FROM COMTN_CNSLT_INFO C
				   LEFT OUTER JOIN (SELECT CODE, CODE_NM
					    	   		  FROM COMTC_CMMN_DETAIL_CODE  	
					    	  		 WHERE CODE_ID = 'COM028') D
				       	ON C.QNA_PROCESS_STTUS_CODE = D.CODE
				   LEFT OUTER JOIN COMVN_USER_MASTER A     
						ON A.ESNTL_ID= C.LAST_UPDUSR_ID
				   LEFT OUTER JOIN COMTN_ORGNZT_INFO B     
						ON A.ORGNZT_ID = B.ORGNZT_ID
			 WHERE CNSLT_ID = #{cnsltId}
		]]>
	</select>

	<update id="updateCnsltDtlsAnswer">
		<![CDATA[
			UPDATE COMTN_CNSLT_INFO	
			   SET QNA_PROCESS_STTUS_CODE	= #{qnaProcessSttusCode}
				 , MANAGT_CN				= #{managtCn}
				 , MANAGT_DE				= now()
				 , LAST_UPDUSR_ID			= #{lastUpdusrId}
				 , LAST_UPDT_PNTTM			= now()
			 WHERE CNSLT_ID = #{cnsltId}
		]]>
	</update>

	<delete id="deleteCnsltDtlsAnswer">
		<![CDATA[
			DELETE 
			  FROM COMTN_CNSLT_INFO
			 WHERE CNSLT_ID=#{cnsltId}
		]]>
	</delete>

</mapper>
