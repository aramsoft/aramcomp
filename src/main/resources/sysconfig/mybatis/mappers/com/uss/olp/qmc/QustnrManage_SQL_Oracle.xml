<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.olp.qmc.dao.QustnrManageMapper">

	<!-- 설문정보::설문템플릿정보 -->
	<select id="selectQustnrTmplatManageList" resultType="egovMap">
		<![CDATA[
			SELECT QUSTNR_TMPLAT_ID	 		AS "qestnrTmplatId"
			     , QUSTNR_TMPLAT_TY	 		AS "qestnrTmplatTy"
			  FROM COMTN_QUSTNR_TMPLAT
        ]]>
	</select>

	<!-- 설문정보::목록조회_게시물정보 -->
	<select id="selectQustnrManageList" resultType="egovMap">
		<![CDATA[
            SELECT *
              FROM (
            SELECT ROWNUM RNUM, ALL_LIST.*
              FROM (
        ]]>
        /* 구현 Sql */
       	<![CDATA[
			SELECT A.QESTNR_ID				AS "qestnrId"
			     , A.QUSTNR_SJ				AS "qestnrSj" 
			     , A.QUSTNR_BGNDE  			AS "qestnrBeginDe"  
			     , A.QUSTNR_ENDDE  			AS "qestnrEndDe"  
			     , A.QUSTNR_TMPLAT_ID	 	AS "qestnrTmplatId" 
			     , A.FRST_REGIST_PNTTM	 	AS "frstRegisterPnttm" 
			     , (SELECT USER_NM 
			          FROM COMVN_USER_MASTER 
			         WHERE ESNTL_ID = A.FRST_REGISTER_ID
			       ) 						AS "frstRegisterNm" 
			  FROM COMTN_QESTNR_INFO A
			 WHERE 1=1
		]]>
    	<if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND A.TRGET_ID = #{trgetId} ]]>
		</if>
   	    <if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "QUSTNR_SJ"'>
               	<![CDATA[ AND A.QUSTNR_SJ LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "FRST_REGISTER_ID"'>
       			<![CDATA[
			   		AND A.FRST_REGISTER_ID IN (SELECT ESNTL_ID 
			 					          	     FROM COMVN_USER_MASTER 
			 						      	    WHERE USER_NM LIKE '%' || #{searchKeyword} || '%' )
				]]>
            </when>
        </choose>
		</if>
		<![CDATA[
			 ORDER BY A.FRST_REGIST_PNTTM DESC
		]]>
        /* 구현 Sql */
        <![CDATA[
                   ) ALL_LIST
                   )
             WHERE RNUM BETWEEN #{firstIndex} + 1 AND #{firstIndex} + #{recordPerPage}
        ]]>			
	</select>

	<!-- 설문정보::목록조회_게시물 총갯수  -->
	<select id="selectQustnrManageListCnt" resultType="int">
       	<![CDATA[
			SELECT COUNT(*) totcnt
		  	  FROM COMTN_QESTNR_INFO A
			 WHERE 1=1
		]]>
    	<if test='trgetId != null and trgetId != ""'>
		   		<![CDATA[ AND A.TRGET_ID = #{trgetId} ]]>
		</if>
   	    <if test='searchKeyword != null and searchKeyword != ""'>
        <choose>
            <when test='searchCondition == "QUSTNR_SJ"'>
               	<![CDATA[ AND A.QUSTNR_SJ LIKE '%'|| #{searchKeyword} ||'%' ]]>
            </when>
            <when test='searchCondition == "FRST_REGISTER_ID"'>
       			<![CDATA[
			   		AND A.FRST_REGISTER_ID IN (SELECT ESNTL_ID 
			 					          	     FROM COMVN_USER_MASTER 
			 						      	    WHERE USER_NM LIKE '%' || #{searchKeyword} || '%' )
				]]>
            </when>
        </choose>
		</if>
	</select>

	<!-- 설문정보::상세보기 -->
	<select id="selectQustnrManageDetail" resultType="qustnrManageVO">
       	<![CDATA[
			SELECT A.QESTNR_ID					AS "qestnrId"
			     , A.QUSTNR_SJ					AS "qestnrSj" 
			     , A.QUSTNR_PURPS				AS "qestnrPurps"
			     , A.QUSTNR_WRITNG_GUIDANCE_CN	AS "qestnrWritngGuidanceCn"
			     , A.QUSTNR_BGNDE				AS "qestnrBeginDe"
			     , A.QUSTNR_ENDDE				AS "qestnrEndDe"
			     , A.QUSTNR_TRGET				AS "qestnrTrget" 
			     , A.QUSTNR_TMPLAT_ID			AS "qestnrTmplatId" 
			     , (SELECT QUSTNR_TMPLAT_TY 
			          FROM COMTN_QUSTNR_TMPLAT 
			         WHERE QUSTNR_TMPLAT_ID = A.QUSTNR_TMPLAT_ID
			       ) 							AS "qestnrTmplatTy"
			     , A.FRST_REGIST_PNTTM			AS "frstRegisterPnttm"
			     , A.FRST_REGISTER_ID			AS "frstRegisterId"
			     , A.LAST_UPDT_PNTTM			AS "lastUpdusrPnttm"
			     , A.LAST_UPDUSR_ID				AS "lastUpdusrId"
			  FROM COMTN_QESTNR_INFO A
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</select>

	<!-- 설문정보::입력  -->
	<insert id="insertQustnrManage">
	 	<![CDATA[
			INSERT INTO COMTN_QESTNR_INFO (
					QESTNR_ID
				  ,	QUSTNR_SJ
				  ,	QUSTNR_PURPS
				  ,	QUSTNR_WRITNG_GUIDANCE_CN
				  ,	QUSTNR_BGNDE
				  ,	QUSTNR_ENDDE
				  ,	QUSTNR_TRGET
				  ,	QUSTNR_TMPLAT_ID
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
				  ,	TRGET_ID
			) VALUES (
					#{qestnrId}
				  ,	#{qestnrSj}
				  ,	#{qestnrPurps}
				  ,	#{qestnrWritngGuidanceCn}
				  ,	#{qestnrBeginDe}
				  ,	#{qestnrEndDe}
				  ,	#{qestnrTrget}
				  ,	#{qestnrTmplatId}
				  , #{frstRegisterId}
				  , SYSDATE
				  , #{frstRegisterId} 
				  , SYSDATE
				  ,	#{trgetId}
			)
	 	]]>
	</insert>

	<!-- 설문정보::수정  -->
	<update id="updateQustnrManage">
	 	<![CDATA[
			UPDATE COMTN_QESTNR_INFO
			   SET QUSTNR_SJ			= #{qestnrSj}
			     , QUSTNR_PURPS			= #{qestnrPurps}
			     , QUSTNR_TMPLAT_ID		= #{qestnrTmplatId}
			     , QUSTNR_WRITNG_GUIDANCE_CN = #{qestnrWritngGuidanceCn}
			     , QUSTNR_BGNDE			= #{qestnrBeginDe}
			     , QUSTNR_TRGET			= #{qestnrTrget}
			     , QUSTNR_ENDDE			= #{qestnrEndDe}
			     , LAST_UPDUSR_ID 		= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM 		= SYSDATE
			 WHERE QESTNR_ID = #{qestnrId}
	 	]]>
	</update>

	<!-- 설문응답자 삭제 -->
	<delete id="deleteQustnrRespondManage">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_RESPOND_INFO 
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</delete>
	<!-- 설문조사(설문결과) 삭제 -->
	<delete id="deleteQustnrRespondInfo">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_RSPNS_RESULT 
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</delete>
	<!-- 설문항목 삭제 -->
	<delete id="deleteQustnrItemManage">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_IEM 
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</delete>
	<!-- 설문문항 삭제 -->
	<delete id="deleteQustnrQestnManage">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_QESITM 
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</delete>

	<!-- 설문정보::삭제  -->
	<delete id="deleteQustnrManage">
		<![CDATA[
			DELETE 
			  FROM COMTN_QESTNR_INFO
			 WHERE QESTNR_ID = #{qestnrId}
		]]>
	</delete>

</mapper>