<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="aramframework.com.uss.olp.qqm.dao.QustnrQestnManageMapper">

	<!-- 설문문항::목록조회_게시물정보 -->
	<select id="selectQustnrQestnManageList" resultType="egovMap">
		<![CDATA[
            SELECT *
              FROM (
            SELECT ROWNUM RNUM, ALL_LIST.*
              FROM (
        ]]>
        /* 구현 Sql */
       	<![CDATA[
			SELECT A.QUSTNR_QESITM_ID	    AS "qestnrQesitmId" 
			     , A.QESTNR_ID				AS "qestnrId"
			     , (SELECT QUSTNR_SJ 
			          FROM COMTN_QESTNR_INFO 
			         WHERE QESTNR_ID=A.QESTNR_ID
			       ) 						AS "qestnrSj"
			     , A.QESTN_TY_CODE			AS "qestnTyCode"
			     , A.QESTN_CN				AS "qestnCn"
			     , A.FRST_REGIST_PNTTM		AS "frstRegisterPnttm" 
			     , (SELECT USER_NM 
			          FROM COMVN_USER_MASTER 
			         WHERE ESNTL_ID = A.FRST_REGISTER_ID
			       ) 						AS "frstRegisterNm" 
		      FROM COMTN_QUSTNR_QESITM A
		     WHERE 1=1
	 	]]>
   	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "QESTN_CN"'>
               	<![CDATA[ AND A.QESTN_CN LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "MXMM_CHOISE_CO"'>
               	<![CDATA[ AND A.MXMM_CHOISE_CO LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "QESTNR_ID"'>
               	<![CDATA[ AND A.QESTNR_ID = #{searchVO.searchKeyword} ]]>
            </when>
	    </choose>
		</if>
	 	<![CDATA[
		     ORDER BY A.FRST_REGIST_PNTTM DESC
		]]>				
        /* 구현 Sql */
        <![CDATA[
                   ) ALL_LIST
                   )
             WHERE RNUM BETWEEN #{searchVO.firstIndex} + 1 AND #{searchVO.firstIndex} + #{searchVO.recordPerPage}
        ]]>			
	</select>

	<!-- 설문문항::목록조회_게시물 총갯수  -->
	<select id="selectQustnrQestnManageListCnt" resultType="int">
       	<![CDATA[
			SELECT COUNT(*) totcnt
			  FROM COMTN_QUSTNR_QESITM A
			 WHERE 1=1
         ]]>			
   	    <if test='searchVO.searchKeyword != null and searchVO.searchKeyword != ""'>
        <choose>
            <when test='searchVO.searchCondition == "QESTN_CN"'>
               	<![CDATA[ AND A.QESTN_CN LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "MXMM_CHOISE_CO"'>
               	<![CDATA[ AND A.MXMM_CHOISE_CO LIKE '%'|| #{searchVO.searchKeyword} ||'%' ]]>
            </when>
            <when test='searchVO.searchCondition == "QESTNR_ID"'>
               	<![CDATA[ AND A.QESTNR_ID = #{searchVO.searchKeyword} ]]>
            </when>
	    </choose>
		</if>
	</select>

	<!-- 설문문항::상세보기 -->
	<select id="selectQustnrQestnManageDetail" resultType="qustnrQestnManageVO">
       	<![CDATA[
			SELECT A.QUSTNR_QESITM_ID    	AS "qestnrQesitmId"
			     , A.QESTNR_ID 		  		AS "qestnrId"
			     , (SELECT QUSTNR_SJ 
			          FROM COMTN_QESTNR_INFO 
			         WHERE QESTNR_ID=A.QESTNR_ID
			       ) 						AS "qestnrSj"
			     , A.QESTN_SN				AS "qestnSn"
			     , A.QESTN_TY_CODE			AS "qestnTyCode"
			     , A.QESTN_CN				AS "qestnCn"
			     , A.MXMM_CHOISE_CO			AS "mxmmChoiseCo"
			     , A.FRST_REGIST_PNTTM 		AS "frstRegisterPnttm"
			     , A.FRST_REGISTER_ID		AS "frstRegisterId"
			     , A.LAST_UPDT_PNTTM 		AS "lastUpdusrPnttm"
			     , A.LAST_UPDUSR_ID			AS "lastUpdusrId"
			  FROM COMTN_QUSTNR_QESITM A
			 WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId}
         ]]>			
	</select>

	<!-- 설문문항:: 설문지 제목 검색  -->
	<select id="selectQustnrManageQestnrSj" resultType="String">
       	<![CDATA[
			SELECT QUSTNR_SJ
			  FROM COMTN_QESTNR_INFO
			 WHERE QESTNR_ID = #{qestnrId}
         ]]>			
	</select>

	<!-- 설문문항::입력  -->
	<insert id="insertQustnrQestnManage">
	 	<![CDATA[
			INSERT INTO COMTN_QUSTNR_QESITM (
					QUSTNR_QESITM_ID
				  ,	QESTNR_ID
				  , QESTN_SN
				  ,	QESTN_TY_CODE
				  ,	QESTN_CN
				  ,	MXMM_CHOISE_CO
				  , FRST_REGISTER_ID 
				  , FRST_REGIST_PNTTM 
				  , LAST_UPDUSR_ID
				  , LAST_UPDT_PNTTM 
			)VALUES(
					#{qestnrQesitmId}
				  ,	#{qestnrId}
				  ,	#{qestnSn}
				  ,	#{qestnTyCode}
				  ,	#{qestnCn}
				  ,	#{mxmmChoiseCo}
				  , #{frstRegisterId}
				  , SYSDATE
				  , #{frstRegisterId}
				  , SYSDATE
			)
	 	]]>
	</insert>

	<!-- 설문문항::수정  -->
	<update id="updateQustnrQestnManage">
	 	<![CDATA[
			UPDATE COMTN_QUSTNR_QESITM
			   SET QESTN_SN			= #{qestnSn}
			     , QESTN_TY_CODE	= #{qestnTyCode}
			     , QESTN_CN			= #{qestnCn}
			     , MXMM_CHOISE_CO	= #{mxmmChoiseCo}
			     , LAST_UPDUSR_ID 	= #{lastUpdusrId}
			     , LAST_UPDT_PNTTM 	= SYSDATE
			 WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId}
	 	]]>
	</update>

	<!-- 설문조사(설문결과) 삭제 -->
	<delete id="deleteQustnrRespondInfo">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_RSPNS_RESULT 
			 WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId}
	 	]]>
	</delete>
	<!-- 설문항목 삭제 -->
	<delete id="deleteQustnrItemManage">
	 	<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_IEM 
			 WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId}
	 	]]>
	</delete>
	<!-- 설문문항::삭제  -->
	<delete id="deleteQustnrQestnManage">
		<![CDATA[
			DELETE 
			  FROM COMTN_QUSTNR_QESITM
			 WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId}
		]]>
	</delete>

	<!-- 설문문항:: 객관식 통계  -->
	<select id="selectQustnrManageStatistics" resultType="egovMap">
		<![CDATA[
			SELECT (SELECT IEM_CN 			
					  FROM COMTN_QUSTNR_IEM
					 WHERE QUSTNR_IEM_ID = A.QUSTNR_IEM_ID
					) 						AS "iemCn"
				 , COUNT(A.QUSTNR_IEM_ID) 	AS "qustnrIemIdCnt"
				 , ROUND((100/(SELECT COUNT(*) CNT 
				                 FROM COMTN_QUSTNR_RSPNS_RESULT	
				                WHERE QUSTNR_QESITM_ID = #{qestnrQesitmId})) * COUNT(A.QUSTNR_IEM_ID)
				         ) 					AS "qustnrPercent" 
			  FROM COMTN_QUSTNR_RSPNS_RESULT A
			 WHERE 1=1
			   AND A.QUSTNR_QESITM_ID = #{qestnrQesitmId}
			 GROUP BY A.QUSTNR_IEM_ID
		]]>
	</select>
	
	<!-- 설문문항:: 응답자답변내용 결과/기타답변내용 결과 통계  -->
	<select id="selectQustnrManageStatistics2" resultType="egovMap">
		<![CDATA[
			SELECT RESPOND_ANSWER_CN		AS "respondAnswerCn"
			     , ETC_ANSWER_CN			AS "etcAnswerCn"
			  FROM COMTN_QUSTNR_RSPNS_RESULT A
			 WHERE 1=1
			   AND A.QUSTNR_QESITM_ID = #{qestnrQesitmId}
		]]>
	</select>

</mapper>